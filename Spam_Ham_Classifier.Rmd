---
title: "Spam|Ham Email Classifier - Complete Analysis & Testing"
author: "Candace Grant"
date: "November 17, 2025"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: cosmo
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 7,
  fig.align = 'center'
)
```

# Load Libraries

```{r load-libraries}
library(tidyverse)
library(tm)
library(randomForest)
library(caret)
library(pROC)
library(wordcloud)
library(RColorBrewer)

set.seed(643)
```

---

# PART 1: Load & Prepare Data

## Load Emails

```{r load-data}
# Function to safely read emails
read_email_safe <- function(file_path) {
  tryCatch({
    text <- tryCatch({
      readLines(file_path, warn = FALSE, encoding = "UTF-8")
    }, error = function(e) {
      tryCatch({
        readLines(file_path, warn = FALSE, encoding = "latin1")
      }, error = function(e2) {
        readLines(file_path, warn = FALSE)
      })
    })
    
    text <- iconv(text, to = "ASCII", sub = " ")
    text <- paste(text, collapse = " ")
    text <- gsub("[^[:print:]]", " ", text)
    text <- gsub("\\s+", " ", text)
    
    return(text)
  }, error = function(e) {
    return(NA_character_)
  })
}

load_emails <- function(spam_folder, ham_folder, n_samples = 500) {
  cat("Loading spam emails...\n")
  spam_files <- list.files(spam_folder, full.names = TRUE)
  spam_files <- sample(spam_files, min(n_samples, length(spam_files)))
  spam_emails <- lapply(spam_files, read_email_safe)
  
  cat("Loading ham emails...\n")
  ham_files <- list.files(ham_folder, full.names = TRUE)
  ham_files <- sample(ham_files, min(n_samples, length(ham_files)))
  ham_emails <- lapply(ham_files, read_email_safe)
  
  emails_df <- data.frame(
    text = c(unlist(spam_emails), unlist(ham_emails)),
    label = c(rep("spam", length(spam_emails)), 
              rep("ham", length(ham_emails))),
    stringsAsFactors = FALSE
  )
  
  emails_df <- emails_df %>% 
    filter(!is.na(text) & text != "" & nchar(text) > 10) %>%
    mutate(label = as.factor(label))
  
  cat(sprintf("Successfully loaded %d emails\n", nrow(emails_df)))
  return(emails_df)
}

emails <- load_emails(
  spam_folder = "/Users/candace/Documents/Email_Classification_Project/spam",
  ham_folder = "/Users/candace/Documents/Email_Classification_Project/easy_ham",
  n_samples = Inf
)

cat(sprintf("\nTotal: %d emails\n", nrow(emails)))
cat(sprintf("Spam: %d | Ham: %d\n", 
            sum(emails$label == "spam"), 
            sum(emails$label == "ham")))
```

## Preprocess Text

```{r preprocess}
cat("Preprocessing text...\n")

corpus <- VCorpus(VectorSource(emails$text))

clean_corpus <- function(corpus) {
  corpus <- tm_map(corpus, content_transformer(function(x) {
    tryCatch(tolower(x), error = function(e) x)
  }))
  corpus <- tm_map(corpus, removeNumbers)
  corpus <- tm_map(corpus, removePunctuation)
  corpus <- tm_map(corpus, removeWords, stopwords("english"))
  corpus <- tm_map(corpus, stripWhitespace)
  corpus <- tm_map(corpus, stemDocument)
  return(corpus)
}

corpus_clean <- clean_corpus(corpus)

# Create features
dtm <- DocumentTermMatrix(corpus_clean)
dtm <- removeSparseTerms(dtm, 0.99)

emails_df <- as.data.frame(as.matrix(dtm))
colnames(emails_df) <- paste0("term_", colnames(emails_df))
emails_df$label <- emails$label

cat(sprintf("Features: %d terms\n", ncol(emails_df) - 1))
```

---

# PART 2: Train Model

```{r train-model}
# Split data
train_index <- createDataPartition(emails_df$label, p = 0.8, list = FALSE)
train_data <- emails_df[train_index, ]
test_data <- emails_df[-train_index, ]

cat(sprintf("Training: %d | Testing: %d\n", nrow(train_data), nrow(test_data)))

# Train Random Forest
cat("\nTraining model...\n")
rf_model <- randomForest(
  label ~ .,
  data = train_data,
  ntree = 500,
  mtry = sqrt(ncol(train_data) - 1),
  importance = TRUE,
  do.trace = 100
)

print(rf_model)

# Save model
saveRDS(rf_model, "random_forest_spam_classifier.rds")
cat("\n Model saved!\n")
```

---

# PART 3: Evaluate Performance

```{r evaluate}
# Make predictions
predictions <- predict(rf_model, test_data, type = "class")
predictions_prob <- predict(rf_model, test_data, type = "prob")

# Confusion matrix
conf_matrix <- confusionMatrix(predictions, test_data$label, positive = "spam")
print(conf_matrix)

# Extract metrics
accuracy <- conf_matrix$overall['Accuracy']
precision <- conf_matrix$byClass['Precision']
recall <- conf_matrix$byClass['Sensitivity']
f1 <- conf_matrix$byClass['F1']

cat(sprintf("\nðŸ“Š RESULTS:\n"))
cat(sprintf("Accuracy:  %.1f%%\n", accuracy * 100))
cat(sprintf("Precision: %.1f%%\n", precision * 100))
cat(sprintf("Recall:    %.1f%%\n", recall * 100))
cat(sprintf("F1-Score:  %.4f\n", f1))
```

## Confusion Matrix Plot

```{r confusion-plot, fig.height=6, fig.width=7}
cm_data <- as.data.frame(conf_matrix$table)
colnames(cm_data) <- c("Predicted", "Actual", "Freq")

ggplot(cm_data, aes(x = Predicted, y = Actual, fill = Freq)) +
  geom_tile(color = "white", size = 1.5) +
  geom_text(aes(label = Freq), size = 14, fontface = "bold", color = "white") +
  scale_fill_gradient(low = "#fee0d2", high = "#de2d26") +
  labs(title = "Confusion Matrix",
       subtitle = sprintf("Accuracy: %.1f%%", accuracy * 100)) +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold"))
```

## ROC Curve

```{r roc-curve, fig.height=6, fig.width=7}
roc_obj <- roc(test_data$label, predictions_prob[, "spam"], 
               levels = c("ham", "spam"))
auc_value <- auc(roc_obj)

plot(roc_obj, 
     main = sprintf("ROC Curve (AUC = %.4f)", auc_value),
     col = "#1f77b4", lwd = 3)
abline(a = 0, b = 1, lty = 2, col = "red", lwd = 2)
```

## Top Important Words

```{r feature-importance, fig.height=8, fig.width=10}
importance_df <- as.data.frame(importance(rf_model))
importance_df$term <- gsub("^term_", "", rownames(importance_df))
importance_df <- importance_df %>%
  arrange(desc(MeanDecreaseGini)) %>%
  head(20)

ggplot(importance_df, aes(x = reorder(term, MeanDecreaseGini), 
                          y = MeanDecreaseGini)) +
  geom_bar(stat = "identity", fill = "#2ca02c", alpha = 0.8) +
  coord_flip() +
  labs(title = "Top 20 Most Important Words",
       x = "Terms", y = "Importance") +
  theme_minimal()
```

---

# PART 4: Test New Emails

## Prediction Function

```{r prediction-function}
predict_email <- function(email_text, model) {
  # Preprocess
  test_corpus <- VCorpus(VectorSource(email_text))
  test_corpus <- tm_map(test_corpus, content_transformer(function(x) {
    tryCatch(tolower(x), error = function(e) x)
  }))
  test_corpus <- tm_map(test_corpus, removeNumbers)
  test_corpus <- tm_map(test_corpus, removePunctuation)
  test_corpus <- tm_map(test_corpus, removeWords, stopwords("english"))
  test_corpus <- tm_map(test_corpus, stripWhitespace)
  test_corpus <- tm_map(test_corpus, stemDocument)
  
  # Create features
  test_dtm <- DocumentTermMatrix(test_corpus)
  test_df <- as.data.frame(as.matrix(test_dtm))
  colnames(test_df) <- paste0("term_", colnames(test_df))
  
  # Match training features
  model_features <- names(model$forest$xlevels)
  for (feature in model_features) {
    if (!(feature %in% colnames(test_df))) {
      test_df[[feature]] <- 0
    }
  }
  test_df <- test_df[, model_features, drop = FALSE]
  
  # Predict
  pred <- predict(model, test_df, type = "class")
  prob <- predict(model, test_df, type = "prob")
  
  return(list(
    classification = as.character(pred),
    spam_prob = prob[1, "spam"],
    ham_prob = prob[1, "ham"]
  ))
}
```

## Test Examples

### Example 1: Clear Spam

```{r test-spam}
spam_email <- "URGENT! You have won $1,000,000! Click here NOW to claim your prize! FREE MONEY!"

result <- predict_email(spam_email, rf_model)

cat("ðŸ“§ Email:", substr(spam_email, 1, 70), "...\n\n")
cat("ðŸŽ¯ Prediction:", toupper(result$classification), "\n")
cat("ðŸ“Š Confidence:\n")
cat(sprintf("   Spam: %.1f%%\n", result$spam_prob * 100))
cat(sprintf("   Ham:  %.1f%%\n\n", result$ham_prob * 100))
```

### Example 2: Clear Ham (Legitimate)

```{r test-ham}
ham_email <- "Hi Sarah, Can we schedule a meeting for next Tuesday at 2pm to discuss the quarterly report? Thanks, John"

result <- predict_email(ham_email, rf_model)

cat("ðŸ“§ Email:", substr(ham_email, 1, 70), "...\n\n")
cat("ðŸŽ¯ Prediction:", toupper(result$classification), "\n")
cat("ðŸ“Š Confidence:\n")
cat(sprintf("   Spam: %.1f%%\n", result$spam_prob * 100))
cat(sprintf("   Ham:  %.1f%%\n\n", result$ham_prob * 100))
```

### Example 3: Marketing Email

```{r test-marketing}
marketing_email <- "Special offer for our valued customers! Get 30% off your next purchase. Use code SAVE30. Limited time only!"

result <- predict_email(marketing_email, rf_model)

cat("ðŸ“§ Email:", substr(marketing_email, 1, 70), "...\n\n")
cat("ðŸŽ¯ Prediction:", toupper(result$classification), "\n")
cat("ðŸ“Š Confidence:\n")
cat(sprintf("   Spam: %.1f%%\n", result$spam_prob * 100))
cat(sprintf("   Ham:  %.1f%%\n\n", result$ham_prob * 100))
```

### Example 4: Phishing Attempt

```{r test-phishing}
phishing_email <- "Your bank account requires immediate verification. Please click here to confirm your details or your account will be suspended."

result <- predict_email(phishing_email, rf_model)

cat("ðŸ“§ Email:", substr(phishing_email, 1, 70), "...\n\n")
cat("ðŸŽ¯ Prediction:", toupper(result$classification), "\n")
cat("ðŸ“Š Confidence:\n")
cat(sprintf("   Spam: %.1f%%\n", result$spam_prob * 100))
cat(sprintf("   Ham:  %.1f%%\n\n", result$ham_prob * 100))
```

## TEST YOUR OWN SPAM HERE!

```{r test-spam email}
# Test Your Email Here:
my_test_email <- "Getting too Many emails from us? â€“ Please click on the one click unsubscribe link at the bottom of this email

Candace
Greetings
My name is Manav and I'm a Talent Development Manager at SynergisticIT Our records show that you are currently in the job market and actively searching for jobs . Your background suits our program needs.Please see the direct Synergisticit JOPP ROI breakdown against any college degree.

Why Choose SynergisticIT for Your Tech Career?

SynergisticIT stands apart as a pioneer in tech upskilling and job placement. Since 2010, we have empowered thousands of candidates to land roles at Fortune 500 companies such as Apple, Google, Walmart Labs, Ford Motors, Bank of America, Visa, Wells Fargo, Intel, Citi, BHN, JPMC, Walgreens, Autozone, PayPal, Deloitte, and more and get salaries ranging anywhere from $90,000 per annum to $154,000. Our programs are not just about learningâ€”they are about getting hired. We offer:Are you tired of sending out rÃ©sumÃ©s with little to no reply? Frustrated by interview rejections despite your college degree only to find the job market colder and tougher than expected? Youâ€™re not alone. In 2025, the gap between tech job education and real hiring requirements has never been larger.
Please check below and explore the program :
Synergisticit Job Placement Program: Get Hired for Tech Jobs
Explore our specialized programs in JOPP
Java Devops full stack Job placement Program: Get Hired for Java Devops Full stack Jobs.
Data Science Job Placement Program: Get hired for data Analyst Data Scienitsit jobs 
At SynergisticIT, we specialize in transforming aspiring professionals into in-demand Data Scientists and Java DevOps Engineers. With over 15 years of proven experience, a network of 24,000+ tech clients, and a placement rate exceeding 91%, our job placement programs are designed to help you achieve your career ambitionsâ€”no matter your starting point.
We Focus on Java /Full stack/Devops and Data Science /Data Engineers/Data analysts/BI Analysts/ Machine learning/AI candidates
 
.........................
Note: Please allow me to reiterate that I chose to contact you either because your resume had been posted to one of the internet job sites to which we subscribe, or you had previously submitted your resume to our openings I assumed that you are either looking for a new employment opportunity, or you are interested in investigating the current job market.
If you are not currently seeking employment, or if you would prefer, I contact you at some later date, please indicate your date of availability so that I may honor your request. In any event, I respectfully recommend you continue to avail yourself to the employment options and job market information we provide with our e-mail notices.
Thanks again
"

# Run prediction
result <- predict_email(my_test_email, rf_model)

# Display result
cat("\n" , rep("=", 70), "\n")
cat("YOUR TEST EMAIL:\n")
cat(rep("=", 70), "\n\n")
cat("ðŸ“§ Email:", my_test_email, "\n\n")
cat(" PREDICTION:", toupper(result$classification), "\n\n")
cat(" CONFIDENCE:\n")
cat(sprintf("   Spam: %.1f%%\n", result$spam_prob * 100))
cat(sprintf("   Ham:  %.1f%%\n", result$ham_prob * 100))
cat("\n", rep("=", 70), "\n")
```

## TEST YOUR OWN INBOX/HAM EMAIL HERE!

```{r test-inbox|ham email}
# Test Your Email Here:
my_test_email <- "DataExpert.io Community Academy
You're receiving this email from DataExpert.io Community Academy.

I am going live on Monday at 9 AM to celebrate 500k Followers on LinkedIn!
You can join on:YouTube https://youtube.com/live/i-viVzI8-54?feature=share
LinkedIn https://www.linkedin.com/posts/eczachly_500k-linkedin-followers-celebration-live-activity-7398116664896069632-n6-D
Excited to see you there! (there will be extra special things)"
# Run prediction
result <- predict_email(my_test_email, rf_model)

# Display result
cat("\n" , rep("=", 70), "\n")
cat("YOUR TEST EMAIL:\n")
cat(rep("=", 70), "\n\n")
cat("ðŸ“§ Email:", my_test_email, "\n\n")
cat(" PREDICTION:", toupper(result$classification), "\n\n")
cat(" CONFIDENCE:\n")
cat(sprintf("   Spam: %.1f%%\n", result$spam_prob * 100))
cat(sprintf("   Ham:  %.1f%%\n", result$ham_prob * 100))
cat("\n", rep("=", 70), "\n")
```


# Summary

## What This Document Did

1. Loaded emails
2. Preprocessed text (cleaned, stemmed, created features)
3. Trained Random Forest model (500 trees)
4. Achieved **`r round(accuracy * 100, 1)`% accuracy**
5. Tested on 4 example emails
6. Provided function to test YOUR emails

##  Final Results

- **Accuracy:** `r round(accuracy * 100, 1)`%
- **Precision:** `r round(precision * 100, 1)`%
- **Recall:** `r round(recall * 100, 1)`%
- **F1-Score:** `r round(f1, 4)`
- **AUC:** `r round(auc_value, 4)`

## How to Use This

**To test new emails:**
1. Scroll up to "TEST YOUR OWN EMAIL HERE"
2. Change the text in quotes
3. Click the green "Run" button for that chunk
4. See your prediction!



